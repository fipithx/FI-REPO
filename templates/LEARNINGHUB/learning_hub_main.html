{% extends "base.html" %}
{% block title %}
{{ trans('learning_hub_title', default='Learning Hub') }}
{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .tab-button.active { 
        background-color: #2E7D32; 
        color: white; 
        border-bottom: 3px solid #1B5E20;
    }
    .progress-ring {
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }
    .course-card {
        transition: all 0.3s ease;
        border: 1px solid #e5e7eb;
    }
    .course-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        border-color: #2E7D32;
    }
    .lesson-item {
        transition: all 0.2s ease;
        border-left: 4px solid transparent;
    }
    .lesson-item:hover {
        border-left-color: #2E7D32;
        background-color: #f8f9fa;
    }
    .lesson-item.completed {
        border-left-color: #4CAF50;
        background-color: #e8f5e9;
    }
    .video-container {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
    }
    .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    .quiz-option {
        transition: all 0.2s ease;
        cursor: pointer;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        margin: 8px 0;
    }
    .quiz-option:hover {
        border-color: #2E7D32;
        background-color: #f8f9fa;
    }
    .quiz-option.selected {
        border-color: #2E7D32;
        background-color: #e8f5e9;
    }
    .dashboard-metric {
        background: linear-gradient(135deg, #2E7D32 0%, #4CAF50 100%);
        color: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
    }
    .achievement-badge {
        display: inline-block;
        background: linear-gradient(135deg, #FFD700 0%, #FFA000 100%);
        color: #333;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
        margin: 4px;
    }
    .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #2E7D32;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white">
        <div class="container mx-auto px-4 py-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold mb-2">
                        <i class="fas fa-graduation-cap mr-3"></i>
                        {{ trans('learning_hub_title', default='Learning Hub') }}
                    </h1>
                    <p class="text-lg opacity-90">{{ trans('learning_hub_subtitle', default='Enhance your financial knowledge') }}</p>
                </div>
                <div class="text-right">
                    <button onclick="showTab('profile')" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-user mr-2"></i>{{ trans('learning_hub_profile', default='Profile') }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mx-auto px-4 pt-4">
                {% for category, message in messages %}
                    <div class="bg-{{ 'green' if category == 'success' else 'red' }}-100 border border-{{ 'green' if category == 'success' else 'red' }}-400 text-{{ 'green' if category == 'success' else 'red' }}-700 px-4 py-3 rounded mb-4 fade-in">
                        {{ message }}
                        <button onclick="this.parentElement.style.display='none'" class="float-right font-bold">&times;</button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Navigation Tabs -->
    <div class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4">
            <nav class="flex space-x-8 overflow-x-auto">
                <button onclick="showTab('dashboard')" class="tab-button py-4 px-6 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap border-b-2 border-transparent hover:border-gray-300 active">
                    <i class="fas fa-tachometer-alt mr-2"></i>{{ trans('learning_hub_dashboard', default='Dashboard') }}
                </button>
                <button onclick="showTab('courses')" class="tab-button py-4 px-6 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap border-b-2 border-transparent hover:border-gray-300">
                    <i class="fas fa-book mr-2"></i>{{ trans('learning_hub_courses', default='Courses') }}
                </button>
                <button onclick="showTab('lesson')" class="tab-button py-4 px-6 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap border-b-2 border-transparent hover:border-gray-300" style="display: none;">
                    <i class="fas fa-chalkboard mr-2"></i>{{ trans('learning_hub_lesson', default='Lesson') }}
                </button>
                <button onclick="showTab('quiz')" class="tab-button py-4 px-6 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap border-b-2 border-transparent hover:border-gray-300" style="display: none;">
                    <i class="fas fa-question-circle mr-2"></i>{{ trans('learning_hub_quiz', default='Quiz') }}
                </button>
                <button onclick="showTab('profile')" class="tab-button py-4 px-6 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap border-b-2 border-transparent hover:border-gray-300">
                    <i class="fas fa-user mr-2"></i>{{ trans('learning_hub_profile', default='Profile') }}
                </button>
            </nav>
        </div>
    </div>

    <!-- Tab Contents -->
    <div class="container mx-auto px-4 py-8">
        
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Progress Overview -->
                <div class="dashboard-metric">
                    <div class="text-2xl font-bold mb-2">{{ total_completed or 0 }}</div>
                    <div class="text-sm opacity-90">{{ trans('learning_hub_lessons_completed', default='Lessons Completed') }}</div>
                </div>
                <div class="dashboard-metric">
                    <div class="text-2xl font-bold mb-2">{{ total_courses or 0 }}</div>
                    <div class="text-sm opacity-90">{{ trans('learning_hub_courses_available', default='Courses Available') }}</div>
                </div>
                <div class="dashboard-metric">
                    <div class="text-2xl font-bold mb-2">{{ quiz_scores_count or 0 }}</div>
                    <div class="text-sm opacity-90">{{ trans('learning_hub_quizzes_completed', default='Quizzes Completed') }}</div>
                </div>
            </div>

            <!-- Course Progress -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">{{ trans('learning_hub_your_progress', default='Your Progress') }}</h2>
                {% if progress_summary %}
                    <div class="space-y-4">
                        {% for item in progress_summary %}
                            <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="font-semibold">{{ trans(item.course['title_key']) }}</h3>
                                    <span class="text-sm text-gray-500">{{ item['completed'] }}/{{ item['total'] }}</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2 mb-3">
                                    <div class="bg-green-600 h-2 rounded-full transition-all duration-500" style="width: {{ item['percent'] }}%"></div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">{{ item['percent'] }}% {{ trans('learning_hub_complete', default='Complete') }}</span>
                                    {% if item['current_lesson'] %}
                                        <button onclick="loadLesson('{{ item.course['id'] }}', '{{ item['current_lesson'] }}')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                                            <i class="fas fa-play mr-1"></i>{{ trans('learning_hub_continue', default='Continue') }}
                                        </button>
                                    {% elif item.course['modules'] and item.course['modules'][0]['lessons'] %}
                                        <button onclick="loadLesson('{{ item.course['id'] }}', '{{ item.course['modules'][0]['lessons'][0]['id'] }}')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">
                                            <i class="fas fa-play mr-1"></i>{{ trans('learning_hub_start', default='Start') }}
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-8">
                        <i class="fas fa-book-open text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600 mb-4">{{ trans('learning_hub_no_progress', default='No progress yet. Start your learning journey!') }}</p>
                        <button onclick="showTab('courses')" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
                            {{ trans('learning_hub_browse_courses', default='Browse Courses') }}
                        </button>
                    </div>
                {% endif %}
            </div>

            <!-- Achievements -->
            {% if achievements %}
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-bold mb-4">{{ trans('learning_hub_achievements', default='Achievements') }}</h2>
                    <div class="flex flex-wrap">
                        {% for achievement in achievements %}
                            <span class="achievement-badge">
                                <i class="fas fa-trophy mr-1"></i>{{ achievement }}
                            </span>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Courses Tab -->
        <div id="courses-tab" class="tab-content">
            <div class="mb-6">
                <h2 class="text-2xl font-bold mb-4">{{ trans('learning_hub_available_courses', default='Available Courses') }}</h2>
                <p class="text-gray-600">{{ trans('learning_hub_courses_description', default='Choose from our comprehensive financial education courses') }}</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for course_id, course in courses.items() %}
                    <div class="course-card bg-white rounded-lg shadow-sm p-6 hover:shadow-lg transition-all">
                        <div class="mb-4">
                            <h3 class="text-xl font-semibold mb-2">{{ trans(course['title_key']) }}</h3>
                            <p class="text-gray-600 text-sm">{{ trans(course['desc_key']) }}</p>
                        </div>

                        {% set cp = progress.get(course_id, {}) %}
                        {% set total_lessons = 0 %}
                        {% for module in course['modules'] %}
                            {% if module['lessons'] %}
                                {% set total_lessons = total_lessons + module['lessons']|length %}
                            {% endif %}
                        {% endfor %}

                        <div class="mb-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span>{{ trans('learning_hub_progress', default='Progress') }}</span>
                                <span>{{ cp.get('lessons_completed', [])|length }}/{{ total_lessons }}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                {% set progress_percent = (cp.get('lessons_completed', [])|length / total_lessons * 100) if total_lessons > 0 else 0 %}
                                <div class="bg-green-600 h-2 rounded-full transition-all duration-500" style="width: {{ progress_percent }}%"></div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">{{ total_lessons }} {{ trans('learning_hub_lessons', default='lessons') }}</span>
                            <button onclick="loadCourseOverview('{{ course_id }}')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">
                                {{ trans('learning_hub_view_course', default='View Course') }}
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Course Overview Tab -->
        <div id="course-overview-tab" class="tab-content">
            <div id="course-overview-content">
                <!-- Content loaded dynamically -->
            </div>
        </div>

        <!-- Lesson Tab -->
        <div id="lesson-tab" class="tab-content">
            <div id="lesson-content">
                <!-- Content loaded dynamically -->
            </div>
        </div>

        <!-- Quiz Tab -->
        <div id="quiz-tab" class="tab-content">
            <div id="quiz-content">
                <!-- Content loaded dynamically -->
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="profile-tab" class="tab-content">
            <div class="max-w-md mx-auto bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-bold mb-4">{{ trans('learning_hub_profile_settings', default='Profile Settings') }}</h2>
                <form id="profile-form" method="POST" action="{{ url_for('learning_hub.profile') }}">
                    {{ profile_form.hidden_tag() if profile_form }}
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('core_first_name', default='First Name') }}</label>
                        <input type="text" name="first_name" value="{{ profile_data.get('first_name', '') }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">{{ trans('core_email', default='Email') }}</label>
                        <input type="email" name="email" value="{{ profile_data.get('email', '') }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div class="mb-6">
                        <label class="flex items-center">
                            <input type="checkbox" name="send_email" {{ 'checked' if profile_data.get('send_email') }} class="mr-2">
                            <span class="text-sm text-gray-700">{{ trans('learning_hub_email_notifications', default='Receive email notifications') }}</span>
                        </label>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors">
                        {{ trans('core_save', default='Save') }}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-lg p-6 text-center">
        <div class="loading-spinner mb-4"></div>
        <p>{{ trans('loading', default='Loading...') }}</p>
    </div>
</div>

<script>
// Global variables
let currentCourse = null;
let currentLesson = null;
let currentQuiz = null;

// Tab management
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    const tab = document.getElementById(tabName + '-tab');
    if (tab) {
        tab.classList.add('active');
        tab.classList.add('fade-in');
    }
    
    // Activate corresponding button
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(btn => {
        if (btn.textContent.toLowerCase().includes(tabName.toLowerCase()) || 
            btn.onclick?.toString().includes(tabName)) {
            btn.classList.add('active');
        }
    });
}

// Show loading modal
function showLoading() {
    document.getElementById('loading-modal').style.display = 'flex';
}

// Hide loading modal
function hideLoading() {
    document.getElementById('loading-modal').style.display = 'none';
}

// Load course overview
async function loadCourseOverview(courseId) {
    showLoading();
    try {
        const response = await fetch(`{{ url_for('learning_hub.get_course_data') }}?course_id=${courseId}`);
        const data = await response.json();
        
        if (data.success) {
            currentCourse = data.course;
            renderCourseOverview(data.course, data.progress);
            showTab('course-overview');
        } else {
            alert(data.message || 'Error loading course');
        }
    } catch (error) {
        console.error('Error loading course:', error);
        alert('Error loading course');
    } finally {
        hideLoading();
    }
}

// Render course overview
function renderCourseOverview(course, progress) {
    const content = document.getElementById('course-overview-content');
    let totalLessons = 0;
    course.modules.forEach(module => {
        totalLessons += module.lessons.length;
    });
    
    const completedLessons = progress.lessons_completed ? progress.lessons_completed.length : 0;
    const progressPercent = totalLessons > 0 ? (completedLessons / totalLessons * 100) : 0;
    
    content.innerHTML = `
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-2xl font-bold mb-2">${course.title_en}</h1>
                    <p class="text-gray-600">${course.description_en}</p>
                </div>
                <button onclick="showTab('courses')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-2xl font-bold text-green-600">${totalLessons}</div>
                    <div class="text-sm text-gray-600">Total Lessons</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600">${completedLessons}</div>
                    <div class="text-sm text-gray-600">Completed</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600">${Math.round(progressPercent)}%</div>
                    <div class="text-sm text-gray-600">Progress</div>
                </div>
            </div>
            
            <div class="mb-6">
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="bg-green-600 h-3 rounded-full transition-all duration-500" style="width: ${progressPercent}%"></div>
                </div>
            </div>
            
            ${progress.current_lesson ? 
                `<button onclick="loadLesson('${course.id}', '${progress.current_lesson}')" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors mr-4">
                    <i class="fas fa-play mr-2"></i>Continue Learning
                </button>` :
                (course.modules.length > 0 && course.modules[0].lessons.length > 0 ? 
                    `<button onclick="loadLesson('${course.id}', '${course.modules[0].lessons[0].id}')" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors mr-4">
                        <i class="fas fa-play mr-2"></i>Start Course
                    </button>` : '')
            }
        </div>
        
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-bold mb-4">Course Modules</h2>
            ${course.modules.map(module => `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">${module.title_en || 'Module'}</h3>
                    <div class="space-y-2">
                        ${module.lessons.map(lesson => `
                            <div class="lesson-item p-3 rounded-lg ${progress.lessons_completed && progress.lessons_completed.includes(lesson.id) ? 'completed' : ''}">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        ${progress.lessons_completed && progress.lessons_completed.includes(lesson.id) ? 
                                            '<i class="fas fa-check-circle text-green-600 mr-3"></i>' : 
                                            '<i class="fas fa-play-circle text-gray-400 mr-3"></i>'
                                        }
                                        <span class="font-medium">${lesson.title_en || 'Lesson'}</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        ${lesson.quiz_id ? '<i class="fas fa-question-circle text-blue-600" title="Has Quiz"></i>' : ''}
                                        <button onclick="loadLesson('${course.id}', '${lesson.id}')" class="text-blue-600 hover:text-blue-800">
                                            <i class="fas fa-arrow-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Load lesson
async function loadLesson(courseId, lessonId) {
    showLoading();
    try {
        const response = await fetch(`{{ url_for('learning_hub.get_lesson_data') }}?course_id=${courseId}&lesson_id=${lessonId}`);
        const data = await response.json();
        
        if (data.success) {
            currentCourse = data.course;
            currentLesson = data.lesson;
            renderLesson(data.course, data.lesson, data.progress, data.next_lesson_id);
            showTab('lesson');
            // Show lesson tab button
            document.querySelector('button[onclick="showTab(\'lesson\')"]').style.display = 'block';
        } else {
            alert(data.message || 'Error loading lesson');
        }
    } catch (error) {
        console.error('Error loading lesson:', error);
        alert('Error loading lesson');
    } finally {
        hideLoading();
    }
}

// Render lesson
function renderLesson(course, lesson, progress, nextLessonId) {
    const content = document.getElementById('lesson-content');
    const isCompleted = progress.lessons_completed && progress.lessons_completed.includes(lesson.id);
    
    content.innerHTML = `
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1 class="text-2xl font-bold mb-2">${lesson.title_en || 'Lesson'}</h1>
                    <p class="text-gray-600">${course.title_en}</p>
                </div>
                <button onclick="loadCourseOverview('${course.id}')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mb-6">
                ${lesson.content_type === 'video' ? 
                    `<div class="video-container">
                        <video controls class="rounded-lg">
                            <source src="{{ url_for('learning_hub.serve_uploaded_file', filename='') }}${lesson.content_path}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>` :
                    lesson.content_type === 'slides' ?
                        `<embed src="{{ url_for('learning_hub.serve_uploaded_file', filename='') }}${lesson.content_path}" type="application/pdf" class="w-full h-96 rounded-lg">` :
                        `<div class="prose max-w-none">
                            <p>${lesson.content_en || 'Lesson content goes here.'}</p>
                        </div>`
                }
            </div>
            
            <div class="flex flex-wrap gap-4">
                ${!isCompleted ? 
                    `<button onclick="markLessonComplete('${course.id}', '${lesson.id}')" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-check mr-2"></i>Mark as Complete
                    </button>` :
                    `<div class="bg-green-100 text-green-800 px-6 py-3 rounded-lg">
                        <i class="fas fa-check-circle mr-2"></i>Completed
                    </div>`
                }
                
                ${lesson.quiz_id ? 
                    `<button onclick="loadQuiz('${course.id}', '${lesson.quiz_id}')" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-question-circle mr-2"></i>Take Quiz
                    </button>` : ''
                }
                
                ${nextLessonId ? 
                    `<button onclick="loadLesson('${course.id}', '${nextLessonId}')" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors">
                        <i class="fas fa-forward mr-2"></i>Next Lesson
                    </button>` : ''
                }
            </div>
        </div>
    `;
}

// Mark lesson as complete
async function markLessonComplete(courseId, lessonId) {
    showLoading();
    try {
        const formData = new FormData();
        formData.append('course_id', courseId);
        formData.append('lesson_id', lessonId);
        formData.append('action', 'mark_complete');
        
        const response = await fetch('{{ url_for("learning_hub.lesson_action") }}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Reload lesson to show updated state
            loadLesson(courseId, lessonId);
            // Show success message
            showFlashMessage('Lesson marked as complete!', 'success');
        } else {
            alert(data.message || 'Error marking lesson as complete');
        }
    } catch (error) {
        console.error('Error marking lesson complete:', error);
        alert('Error marking lesson as complete');
    } finally {
        hideLoading();
    }
}

// Load quiz
async function loadQuiz(courseId, quizId) {
    showLoading();
    try {
        const response = await fetch(`{{ url_for('learning_hub.get_quiz_data') }}?course_id=${courseId}&quiz_id=${quizId}`);
        const data = await response.json();
        
        if (data.success) {
            currentCourse = data.course;
            currentQuiz = data.quiz;
            renderQuiz(data.course, data.quiz, data.progress);
            showTab('quiz');
            // Show quiz tab button
            document.querySelector('button[onclick="showTab(\'quiz\')"]').style.display = 'block';
        } else {
            alert(data.message || 'Error loading quiz');
        }
    } catch (error) {
        console.error('Error loading quiz:', error);
        alert('Error loading quiz');
    } finally {
        hideLoading();
    }
}

// Render quiz
function renderQuiz(course, quiz, progress) {
    const content = document.getElementById('quiz-content');
    const quizScore = progress.quiz_scores ? progress.quiz_scores[quiz.id] : null;
    
    content.innerHTML = `
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1 class="text-2xl font-bold mb-2">Quiz</h1>
                    <p class="text-gray-600">${course.title_en}</p>
                </div>
                <button onclick="loadCourseOverview('${course.id}')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            ${quizScore !== null ? 
                `<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6">
                    <i class="fas fa-check-circle mr-2"></i>
                    Quiz completed! Score: ${quizScore}/${quiz.questions.length}
                </div>` : ''
            }
            
            <form id="quiz-form" onsubmit="submitQuiz(event, '${course.id}', '${quiz.id}')">
                ${quiz.questions.map((question, index) => `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-4">Question ${index + 1}: ${question.question_en}</h3>
                        <div class="space-y-2">
                            ${question.options_en.map((option, optIndex) => `
                                <label class="quiz-option block cursor-pointer">
                                    <input type="radio" name="q${index}" value="${option}" class="mr-3" ${quizScore !== null ? 'disabled' : ''}>
                                    <span>${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
                
                ${quizScore === null ? 
                    `<button type="submit" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-check mr-2"></i>Submit Quiz
                    </button>` : ''
                }
            </form>
        </div>
    `;
    
    // Add click handlers for quiz options
    document.querySelectorAll('.quiz-option').forEach(option => {
        option.addEventListener('click', function() {
            const radio = this.querySelector('input[type="radio"]');
            if (!radio.disabled) {
                radio.checked = true;
                // Remove selected class from siblings
                this.parentElement.querySelectorAll('.quiz-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                // Add selected class to this option
                this.classList.add('selected');
            }
        });
    });
}

// Submit quiz
async function submitQuiz(event, courseId, quizId) {
    event.preventDefault();
    showLoading();
    
    try {
        const formData = new FormData(event.target);
        formData.append('course_id', courseId);
        formData.append('quiz_id', quizId);
        formData.append('action', 'submit_quiz');
        
        const response = await fetch('{{ url_for("learning_hub.quiz_action") }}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Reload quiz to show results
            loadQuiz(courseId, quizId);
            showFlashMessage(`Quiz completed! Score: ${data.score}/${data.total}`, 'success');
        } else {
            alert(data.message || 'Error submitting quiz');
        }
    } catch (error) {
        console.error('Error submitting quiz:', error);
        alert('Error submitting quiz');
    } finally {
        hideLoading();
    }
}

// Show flash message
function showFlashMessage(message, type) {
    const container = document.querySelector('.container');
    const alertDiv = document.createElement('div');
    alertDiv.className = `bg-${type === 'success' ? 'green' : 'red'}-100 border border-${type === 'success' ? 'green' : 'red'}-400 text-${type === 'success' ? 'green' : 'red'}-700 px-4 py-3 rounded mb-4 fade-in`;
    alertDiv.innerHTML = `
        ${message}
        <button onclick="this.parentElement.style.display='none'" class="float-right font-bold">&times;</button>
    `;
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.style.display = 'none';
        }
    }, 5000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set initial tab based on URL hash or default to dashboard
    const hash = window.location.hash.substring(1);
    if (hash && document.getElementById(hash + '-tab')) {
        showTab(hash);
    } else {
        showTab('dashboard');
    }
    
    // Add CSRF token to meta tag if not present
    if (!document.querySelector('meta[name=csrf-token]')) {
        const meta = document.createElement('meta');
        meta.name = 'csrf-token';
        meta.content = '{{ csrf_token() }}';
        document.head.appendChild(meta);
    }
});
</script>
{% endblock %}