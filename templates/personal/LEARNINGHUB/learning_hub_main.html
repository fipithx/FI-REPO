{% extends "base.html" %}
{% block title %}
{{ trans('learning_hub_title', default='Learning Hub') }}
{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .tab-button.active { 
        background-color: #2E7D32; 
        color: white; 
        border-bottom: 3px solid #1B5E20;
    }
    .progress-ring {
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }
    .course-card {
        transition: all 0.3s ease;
        border: 1px solid #e5e7eb;
        background: white;
        border-radius: 12px;
        overflow: hidden;
    }
    .course-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        border-color: #2E7D32;
    }
    .lesson-item {
        transition: all 0.2s ease;
        border-left: 4px solid transparent;
        padding: 16px;
        border-radius: 8px;
        margin: 8px 0;
    }
    .lesson-item:hover {
        border-left-color: #2E7D32;
        background-color: #f8f9fa;
        transform: translateX(4px);
    }
    .lesson-item.completed {
        border-left-color: #4CAF50;
        background-color: #e8f5e9;
    }
    .video-container {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
        border-radius: 12px;
        overflow: hidden;
    }
    .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .quiz-option {
        transition: all 0.2s ease;
        cursor: pointer;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        margin: 8px 0;
        background: white;
    }
    .quiz-option:hover {
        border-color: #2E7D32;
        background-color: #f8f9fa;
        transform: scale(1.02);
    }
    .quiz-option.selected {
        border-color: #2E7D32;
        background-color: #e8f5e9;
        box-shadow: 0 4px 12px rgba(46, 125, 50, 0.2);
    }
    .dashboard-metric {
        background: linear-gradient(135deg, #2E7D32 0%, #4CAF50 100%);
        color: white;
        border-radius: 16px;
        padding: 24px;
        text-align: center;
        box-shadow: 0 8px 24px rgba(46, 125, 50, 0.3);
    }
    .achievement-badge {
        display: inline-block;
        background: linear-gradient(135deg, #FFD700 0%, #FFA000 100%);
        color: #333;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
        margin: 4px;
        box-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
    }
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #2E7D32;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .fade-in {
        animation: fadeIn 0.6s ease-in;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .slide-in {
        animation: slideIn 0.4s ease-out;
    }
    @keyframes slideIn {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
    }
    .progress-bar-animated {
        background: linear-gradient(90deg, #2E7D32, #4CAF50, #66BB6A);
        background-size: 200% 100%;
        animation: progressShine 2s ease-in-out infinite;
    }
    @keyframes progressShine {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    .btn-primary {
        background: linear-gradient(135deg, #2E7D32 0%, #4CAF50 100%);
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(46, 125, 50, 0.4);
    }
    .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(108, 117, 125, 0.3);
    }
    .module-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 20px;
        margin: 16px 0;
        border-left: 5px solid #2E7D32;
    }
    .lesson-content {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        margin: 20px 0;
    }
    .quiz-container {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    .profile-card {
        background: white;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        max-width: 500px;
        margin: 0 auto;
    }
    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 24px;
    }
    .nav-tabs .nav-link {
        border: none;
        border-radius: 8px 8px 0 0;
        padding: 12px 24px;
        font-weight: 600;
        color: #6c757d;
        transition: all 0.3s ease;
    }
    .nav-tabs .nav-link:hover {
        background-color: #f8f9fa;
        color: #2E7D32;
    }
    .nav-tabs .nav-link.active {
        background-color: #2E7D32;
        color: white;
        border-bottom: 3px solid #1B5E20;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    <!-- Header -->
    <div class="bg-gradient-to-r from-green-600 via-green-700 to-blue-600 text-white">
        <div class="container mx-auto px-4 py-12">
            <div class="flex items-center justify-between">
                <div class="slide-in">
                    <h1 class="text-4xl font-bold mb-3">
                        <i class="fas fa-graduation-cap mr-4"></i>
                        {{ trans('learning_hub_title', default='Learning Hub') }}
                    </h1>
                    <p class="text-xl opacity-90">{{ trans('learning_hub_subtitle', default='Enhance your financial knowledge with interactive courses') }}</p>
                </div>
                <div class="text-right slide-in">
                    <button onclick="showTab('profile')" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-6 py-3 rounded-xl transition-all transform hover:scale-105">
                        <i class="fas fa-user mr-2"></i>{{ trans('learning_hub_profile', default='Profile') }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mx-auto px-4 pt-6">
                {% for category, message in messages %}
                    <div class="bg-{{ 'green' if category == 'success' else 'red' }}-100 border border-{{ 'green' if category == 'success' else 'red' }}-400 text-{{ 'green' if category == 'success' else 'red' }}-700 px-6 py-4 rounded-lg mb-4 fade-in shadow-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' }} mr-3"></i>
                                {{ message }}
                            </div>
                            <button onclick="this.parentElement.parentElement.style.display='none'" class="text-xl font-bold hover:opacity-70">&times;</button>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Navigation Tabs -->
    <div class="bg-white shadow-lg border-b-2 border-gray-200">
        <div class="container mx-auto px-4">
            <nav class="nav-tabs flex space-x-2 overflow-x-auto">
                <button onclick="showTab('dashboard')" class="nav-link tab-button py-4 px-6 text-sm font-medium whitespace-nowrap active">
                    <i class="fas fa-tachometer-alt mr-2"></i>{{ trans('learning_hub_dashboard', default='Dashboard') }}
                </button>
                <button onclick="showTab('courses')" class="nav-link tab-button py-4 px-6 text-sm font-medium whitespace-nowrap">
                    <i class="fas fa-book mr-2"></i>{{ trans('learning_hub_courses', default='Courses') }}
                </button>
                <button onclick="showTab('lesson')" class="nav-link tab-button py-4 px-6 text-sm font-medium whitespace-nowrap" style="display: none;">
                    <i class="fas fa-chalkboard mr-2"></i>{{ trans('learning_hub_lesson', default='Lesson') }}
                </button>
                <button onclick="showTab('quiz')" class="nav-link tab-button py-4 px-6 text-sm font-medium whitespace-nowrap" style="display: none;">
                    <i class="fas fa-question-circle mr-2"></i>{{ trans('learning_hub_quiz', default='Quiz') }}
                </button>
                <button onclick="showTab('profile')" class="nav-link tab-button py-4 px-6 text-sm font-medium whitespace-nowrap">
                    <i class="fas fa-user mr-2"></i>{{ trans('learning_hub_profile', default='Profile') }}
                </button>
            </nav>
        </div>
    </div>

    <!-- Tab Contents -->
    <div class="container mx-auto px-4 py-8">
        
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
                <!-- Progress Overview -->
                <div class="dashboard-metric slide-in">
                    <div class="text-3xl font-bold mb-3">{{ total_completed or 0 }}</div>
                    <div class="text-lg opacity-90">{{ trans('learning_hub_lessons_completed', default='Lessons Completed') }}</div>
                    <div class="mt-2">
                        <i class="fas fa-check-circle text-2xl"></i>
                    </div>
                </div>
                <div class="dashboard-metric slide-in" style="animation-delay: 0.1s;">
                    <div class="text-3xl font-bold mb-3">{{ total_courses or 0 }}</div>
                    <div class="text-lg opacity-90">{{ trans('learning_hub_courses_available', default='Courses Available') }}</div>
                    <div class="mt-2">
                        <i class="fas fa-book text-2xl"></i>
                    </div>
                </div>
                <div class="dashboard-metric slide-in" style="animation-delay: 0.2s;">
                    <div class="text-3xl font-bold mb-3">{{ quiz_scores_count or 0 }}</div>
                    <div class="text-lg opacity-90">{{ trans('learning_hub_quizzes_completed', default='Quizzes Completed') }}</div>
                    <div class="mt-2">
                        <i class="fas fa-trophy text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Course Progress -->
            <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i class="fas fa-chart-line mr-3 text-green-600"></i>
                    {{ trans('learning_hub_your_progress', default='Your Learning Progress') }}
                </h2>
                {% if progress_summary %}
                    <div class="space-y-6">
                        {% for item in progress_summary %}
                            <div class="border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-all duration-300 hover:border-green-300">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-xl font-semibold text-gray-800">{{ trans(item.course['title_key']) }}</h3>
                                    <span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">{{ item['completed'] }}/{{ item['total'] }} lessons</span>
                                </div>
                                <p class="text-gray-600 mb-4">{{ trans(item.course['desc_key']) }}</p>
                                <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                                    <div class="progress-bar-animated h-3 rounded-full transition-all duration-1000" style="width: {{ item['percent'] }}%"></div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-lg font-semibold text-green-600">{{ item['percent'] }}% {{ trans('learning_hub_complete', default='Complete') }}</span>
                                    {% if item['current_lesson'] %}
                                        <button onclick="loadLesson('{{ item.course['id'] }}', '{{ item['current_lesson'] }}')" class="btn-primary">
                                            <i class="fas fa-play mr-2"></i>{{ trans('learning_hub_continue', default='Continue Learning') }}
                                        </button>
                                    {% elif item.course['modules'] and item.course['modules'][0]['lessons'] %}
                                        <button onclick="loadLesson('{{ item.course['id'] }}', '{{ item.course['modules'][0]['lessons'][0]['id'] }}')" class="btn-primary">
                                            <i class="fas fa-rocket mr-2"></i>{{ trans('learning_hub_start', default='Start Course') }}
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-16">
                        <div class="mb-6">
                            <i class="fas fa-book-open text-6xl text-gray-400"></i>
                        </div>
                        <h3 class="text-2xl font-semibold text-gray-600 mb-4">{{ trans('learning_hub_no_progress', default='Ready to start your learning journey?') }}</h3>
                        <p class="text-gray-500 mb-8 text-lg">{{ trans('learning_hub_no_progress_desc', default='Explore our comprehensive financial education courses and begin building your knowledge today.') }}</p>
                        <button onclick="showTab('courses')" class="btn-primary text-lg px-8 py-4">
                            <i class="fas fa-compass mr-2"></i>{{ trans('learning_hub_browse_courses', default='Explore Courses') }}
                        </button>
                    </div>
                {% endif %}
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-clock mr-2 text-blue-600"></i>
                        {{ trans('learning_hub_recent_activity', default='Recent Activity') }}
                    </h3>
                    <div class="space-y-3">
                        {% if progress_summary %}
                            {% for item in progress_summary[:3] %}
                                <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0">
                                    <span class="text-gray-700">{{ trans(item.course['title_key']) }}</span>
                                    <span class="text-sm text-green-600 font-medium">{{ item['percent'] }}%</span>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-gray-500 italic">{{ trans('learning_hub_no_activity', default='No recent activity') }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-target mr-2 text-purple-600"></i>
                        {{ trans('learning_hub_learning_goals', default='Learning Goals') }}
                    </h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between py-2">
                            <span class="text-gray-700">{{ trans('learning_hub_complete_course', default='Complete a course') }}</span>
                            <i class="fas fa-{{ 'check-circle text-green-600' if total_completed > 0 else 'circle text-gray-400' }}"></i>
                        </div>
                        <div class="flex items-center justify-between py-2">
                            <span class="text-gray-700">{{ trans('learning_hub_take_quiz', default='Take a quiz') }}</span>
                            <i class="fas fa-{{ 'check-circle text-green-600' if quiz_scores_count > 0 else 'circle text-gray-400' }}"></i>
                        </div>
                        <div class="flex items-center justify-between py-2">
                            <span class="text-gray-700">{{ trans('learning_hub_complete_all', default='Complete all courses') }}</span>
                            <i class="fas fa-{{ 'check-circle text-green-600' if total_completed >= total_courses else 'circle text-gray-400' }}"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Courses Tab -->
        <div id="courses-tab" class="tab-content">
            <div class="mb-8">
                <h2 class="text-3xl font-bold mb-4 text-gray-800">{{ trans('learning_hub_available_courses', default='Available Courses') }}</h2>
                <p class="text-gray-600 text-lg">{{ trans('learning_hub_courses_description', default='Choose from our comprehensive financial education courses designed to enhance your financial literacy') }}</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {% for course_id, course in courses.items() %}
                    <div class="course-card hover:shadow-2xl transition-all duration-300">
                        <div class="p-6">
                            <div class="mb-6">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-xl font-bold text-gray-800">{{ trans(course['title_key']) }}</h3>
                                    <i class="fas fa-book text-2xl text-green-600"></i>
                                </div>
                                <p class="text-gray-600 leading-relaxed">{{ trans(course['desc_key']) }}</p>
                            </div>

                            {% set cp = progress.get(course_id, {}) %}
                            {% set total_lessons = 0 %}
                            {% for module in course['modules'] %}
                                {% if module['lessons'] %}
                                    {% set total_lessons = total_lessons + module['lessons']|length %}
                                {% endif %}
                            {% endfor %}

                            <div class="mb-6">
                                <div class="flex justify-between text-sm text-gray-600 mb-2">
                                    <span class="font-medium">{{ trans('learning_hub_progress', default='Progress') }}</span>
                                    <span class="font-semibold">{{ cp.get('lessons_completed', [])|length }}/{{ total_lessons }}</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    {% set progress_percent = (cp.get('lessons_completed', [])|length / total_lessons * 100) if total_lessons > 0 else 0 %}
                                    <div class="progress-bar-animated h-3 rounded-full transition-all duration-1000" style="width: {{ progress_percent }}%"></div>
                                </div>
                                <div class="mt-2 text-sm text-green-600 font-semibold">{{ progress_percent|round }}% Complete</div>
                            </div>

                            <div class="flex justify-between items-center">
                                <div class="text-sm text-gray-500 flex items-center">
                                    <i class="fas fa-graduation-cap mr-1"></i>
                                    {{ total_lessons }} {{ trans('learning_hub_lessons', default='lessons') }}
                                </div>
                                <button onclick="loadCourseOverview('{{ course_id }}')" class="btn-primary">
                                    <i class="fas fa-arrow-right mr-2"></i>{{ trans('learning_hub_view_course', default='View Course') }}
                                </button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Course Overview Tab -->
        <div id="course-overview-tab" class="tab-content">
            <div id="course-overview-content">
                <!-- Content loaded dynamically -->
            </div>
        </div>

        <!-- Lesson Tab -->
        <div id="lesson-tab" class="tab-content">
            <div id="lesson-content">
                <!-- Content loaded dynamically -->
            </div>
        </div>

        <!-- Quiz Tab -->
        <div id="quiz-tab" class="tab-content">
            <div id="quiz-content">
                <!-- Content loaded dynamically -->
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="profile-tab" class="tab-content">
            <div class="profile-card">
                <h2 class="text-2xl font-bold mb-6 text-center flex items-center justify-center">
                    <i class="fas fa-user-cog mr-3 text-green-600"></i>
                    {{ trans('learning_hub_profile_settings', default='Profile Settings') }}
                </h2>
                <form id="profile-form" method="POST" action="{{ url_for('learning_hub.profile') }}">
                    {{ profile_form.hidden_tag() if profile_form }}
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                            <i class="fas fa-user mr-2"></i>{{ trans('core_first_name', default='First Name') }}
                        </label>
                        <input type="text" name="first_name" value="{{ profile_data.get('first_name', '') }}" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" 
                               placeholder="Enter your first name" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                            <i class="fas fa-envelope mr-2"></i>{{ trans('core_email', default='Email Address') }}
                        </label>
                        <input type="email" name="email" value="{{ profile_data.get('email', '') }}" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" 
                               placeholder="Enter your email address">
                    </div>
                    <div class="mb-8">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" name="send_email" {{ 'checked' if profile_data.get('send_email') }} 
                                   class="mr-3 w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500">
                            <span class="text-gray-700 font-medium">
                                <i class="fas fa-bell mr-2"></i>{{ trans('learning_hub_email_notifications', default='Receive email notifications for course progress') }}
                            </span>
                        </label>
                    </div>
                    <button type="submit" class="w-full btn-primary text-lg py-4">
                        <i class="fas fa-save mr-2"></i>{{ trans('core_save', default='Save Profile') }}
                    </button>
                </form>
                
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-semibold mb-4">{{ trans('learning_hub_profile_stats', default='Your Learning Stats') }}</h3>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-green-600">{{ total_completed or 0 }}</div>
                            <div class="text-sm text-gray-600">Lessons</div>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-blue-600">{{ quiz_scores_count or 0 }}</div>
                            <div class="text-sm text-gray-600">Quizzes</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-xl p-8 text-center shadow-2xl">
        <div class="loading-spinner mb-6"></div>
        <p class="text-lg font-medium text-gray-700">{{ trans('loading', default='Loading...') }}</p>
    </div>
</div>

<script>
// Global variables
let currentCourse = null;
let currentLesson = null;
let currentQuiz = null;

// Tab management
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    const tab = document.getElementById(tabName + '-tab');
    if (tab) {
        tab.classList.add('active');
        tab.classList.add('fade-in');
    }
    
    // Activate corresponding button
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(btn => {
        if (btn.textContent.toLowerCase().includes(tabName.toLowerCase()) || 
            btn.onclick?.toString().includes(tabName)) {
            btn.classList.add('active');
        }
    });
    
    // Update URL hash
    window.location.hash = tabName;
}

// Show loading modal
function showLoading() {
    document.getElementById('loading-modal').style.display = 'flex';
}

// Hide loading modal
function hideLoading() {
    document.getElementById('loading-modal').style.display = 'none';
}

// Load course overview
async function loadCourseOverview(courseId) {
    showLoading();
    try {
        const response = await fetch(`{{ url_for('learning_hub.get_course_data', course_id='') }}${courseId}`);
        const data = await response.json();
        
        if (data.success) {
            currentCourse = data.course;
            renderCourseOverview(data.course, data.progress);
            showTab('course-overview');
        } else {
            showFlashMessage(data.message || 'Error loading course', 'error');
        }
    } catch (error) {
        console.error('Error loading course:', error);
        showFlashMessage('Error loading course', 'error');
    } finally {
        hideLoading();
    }
}

// Render course overview
function renderCourseOverview(course, progress) {
    const content = document.getElementById('course-overview-content');
    let totalLessons = 0;
    course.modules.forEach(module => {
        totalLessons += module.lessons.length;
    });
    
    const completedLessons = progress.lessons_completed ? progress.lessons_completed.length : 0;
    const progressPercent = totalLessons > 0 ? (completedLessons / totalLessons * 100) : 0;
    
    content.innerHTML = `
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1 class="text-3xl font-bold mb-3 text-gray-800">${course.title_en}</h1>
                    <p class="text-gray-600 text-lg leading-relaxed">${course.description_en}</p>
                </div>
                <button onclick="showTab('courses')" class="text-gray-500 hover:text-gray-700 text-2xl p-2 rounded-full hover:bg-gray-100 transition-all">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="text-center p-6 bg-gradient-to-br from-green-50 to-green-100 rounded-xl">
                    <div class="text-3xl font-bold text-green-600 mb-2">${totalLessons}</div>
                    <div class="text-sm text-gray-600 font-medium">Total Lessons</div>
                </div>
                <div class="text-center p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl">
                    <div class="text-3xl font-bold text-blue-600 mb-2">${completedLessons}</div>
                    <div class="text-sm text-gray-600 font-medium">Completed</div>
                </div>
                <div class="text-center p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl">
                    <div class="text-3xl font-bold text-purple-600 mb-2">${Math.round(progressPercent)}%</div>
                    <div class="text-sm text-gray-600 font-medium">Progress</div>
                </div>
            </div>
            
            <div class="mb-8">
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div class="progress-bar-animated h-4 rounded-full transition-all duration-1000" style="width: ${progressPercent}%"></div>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-4 mb-8">
                ${progress.current_lesson ? 
                    `<button onclick="loadLesson('${course.id}', '${progress.current_lesson}')" class="btn-primary text-lg px-8 py-4">
                        <i class="fas fa-play mr-2"></i>Continue Learning
                    </button>` :
                    (course.modules.length > 0 && course.modules[0].lessons.length > 0 ? 
                        `<button onclick="loadLesson('${course.id}', '${course.modules[0].lessons[0].id}')" class="btn-primary text-lg px-8 py-4">
                            <i class="fas fa-rocket mr-2"></i>Start Course
                        </button>` : '')
                }
                <button onclick="showTab('courses')" class="btn-secondary text-lg px-8 py-4">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Courses
                </button>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-list mr-3 text-green-600"></i>Course Modules
            </h2>
            ${course.modules.map((module, moduleIndex) => `
                <div class="module-header mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-folder-open mr-2 text-green-600"></i>
                        Module ${moduleIndex + 1}: ${module.title_en || 'Module'}
                    </h3>
                    <div class="space-y-3">
                        ${module.lessons.map((lesson, lessonIndex) => `
                            <div class="lesson-item ${progress.lessons_completed && progress.lessons_completed.includes(lesson.id) ? 'completed' : ''}">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        ${progress.lessons_completed && progress.lessons_completed.includes(lesson.id) ? 
                                            '<i class="fas fa-check-circle text-green-600 mr-4 text-xl"></i>' : 
                                            '<i class="fas fa-play-circle text-gray-400 mr-4 text-xl"></i>'
                                        }
                                        <div>
                                            <span class="font-semibold text-gray-800">${lessonIndex + 1}. ${lesson.title_en || 'Lesson'}</span>
                                            <div class="text-sm text-gray-500 mt-1">
                                                <i class="fas fa-${lesson.content_type === 'video' ? 'video' : lesson.content_type === 'slides' ? 'file-pdf' : 'file-text'} mr-1"></i>
                                                ${lesson.content_type === 'video' ? 'Video Lesson' : lesson.content_type === 'slides' ? 'PDF Slides' : 'Text Lesson'}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        ${lesson.quiz_id ? '<i class="fas fa-question-circle text-blue-600 text-lg" title="Has Quiz"></i>' : ''}
                                        <button onclick="loadLesson('${course.id}', '${lesson.id}')" class="text-blue-600 hover:text-blue-800 text-lg hover:bg-blue-50 p-2 rounded-full transition-all">
                                            <i class="fas fa-arrow-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Load lesson
async function loadLesson(courseId, lessonId) {
    showLoading();
    try {
        const response = await fetch(`{{ url_for('learning_hub.get_lesson_data') }}?course_id=${courseId}&lesson_id=${lessonId}`);
        const data = await response.json();
        
        if (data.success) {
            currentCourse = data.course;
            currentLesson = data.lesson;
            renderLesson(data.course, data.lesson, data.progress, data.next_lesson_id);
            showTab('lesson');
            // Show lesson tab button
            document.querySelector('button[onclick="showTab(\'lesson\')"]').style.display = 'block';
        } else {
            showFlashMessage(data.message || 'Error loading lesson', 'error');
        }
    } catch (error) {
        console.error('Error loading lesson:', error);
        showFlashMessage('Error loading lesson', 'error');
    } finally {
        hideLoading();
    }
}

// Render lesson
function renderLesson(course, lesson, progress, nextLessonId) {
    const content = document.getElementById('lesson-content');
    const isCompleted = progress.lessons_completed && progress.lessons_completed.includes(lesson.id);
    
    content.innerHTML = `
        <div class="lesson-content">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h1 class="text-3xl font-bold mb-3 text-gray-800">${lesson.title_en || 'Lesson'}</h1>
                    <p class="text-gray-600 text-lg">${course.title_en}</p>
                    <div class="flex items-center mt-3 text-sm text-gray-500">
                        <i class="fas fa-${lesson.content_type === 'video' ? 'video' : lesson.content_type === 'slides' ? 'file-pdf' : 'file-text'} mr-2"></i>
                        ${lesson.content_type === 'video' ? 'Video Lesson' : lesson.content_type === 'slides' ? 'PDF Slides' : 'Text Lesson'}
                    </div>
                </div>
                <button onclick="loadCourseOverview('${course.id}')" class="text-gray-500 hover:text-gray-700 text-2xl p-2 rounded-full hover:bg-gray-100 transition-all">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-8">
                ${lesson.content_type === 'video' ? 
                    `<div class="video-container shadow-lg">
                        <video controls class="rounded-xl" controlsList="nodownload">
                            <source src="{{ url_for('learning_hub.serve_uploaded_file', filename='') }}${lesson.content_path}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>` :
                    lesson.content_type === 'slides' ?
                        `<div class="bg-gray-100 rounded-xl p-4">
                            <embed src="{{ url_for('learning_hub.serve_uploaded_file', filename='') }}${lesson.content_path}" 
                                   type="application/pdf" class="w-full h-96 rounded-lg shadow-inner">
                        </div>` :
                        `<div class="prose max-w-none bg-gray-50 rounded-xl p-8">
                            <p class="text-lg leading-relaxed text-gray-700">${lesson.content_en || 'Lesson content goes here.'}</p>
                        </div>`
                }
            </div>
            
            <div class="flex flex-wrap gap-4 mb-8">
                ${!isCompleted ? 
                    `<button onclick="markLessonComplete('${course.id}', '${lesson.id}')" class="btn-primary text-lg px-8 py-4">
                        <i class="fas fa-check mr-2"></i>Mark as Complete
                    </button>` :
                    `<div class="bg-green-100 text-green-800 px-8 py-4 rounded-xl font-semibold text-lg">
                        <i class="fas fa-check-circle mr-2"></i>Lesson Completed
                    </div>`
                }
                
                ${lesson.quiz_id ? 
                    `<button onclick="loadQuiz('${course.id}', '${lesson.quiz_id}')" class="btn-primary bg-blue-600 hover:bg-blue-700 text-lg px-8 py-4">
                        <i class="fas fa-question-circle mr-2"></i>Take Quiz
                    </button>` : ''
                }
                
                ${nextLessonId ? 
                    `<button onclick="loadLesson('${course.id}', '${nextLessonId}')" class="btn-primary bg-purple-600 hover:bg-purple-700 text-lg px-8 py-4">
                        <i class="fas fa-forward mr-2"></i>Next Lesson
                    </button>` : ''
                }
                
                <button onclick="loadCourseOverview('${course.id}')" class="btn-secondary text-lg px-8 py-4">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Course
                </button>
            </div>
        </div>
    `;
}

// Mark lesson as complete
async function markLessonComplete(courseId, lessonId) {
    showLoading();
    try {
        const formData = new FormData();
        formData.append('course_id', courseId);
        formData.append('lesson_id', lessonId);
        formData.append('action', 'mark_complete');
        formData.append('csrf_token', getCSRFToken());
        
        const response = await fetch('{{ url_for("learning_hub.lesson_action") }}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Reload lesson to show updated state
            loadLesson(courseId, lessonId);
            showFlashMessage('Lesson marked as complete!', 'success');
        } else {
            showFlashMessage(data.message || 'Error marking lesson as complete', 'error');
        }
    } catch (error) {
        console.error('Error marking lesson complete:', error);
        showFlashMessage('Error marking lesson as complete', 'error');
    } finally {
        hideLoading();
    }
}

// Load quiz
async function loadQuiz(courseId, quizId) {
    showLoading();
    try {
        const response = await fetch(`{{ url_for('learning_hub.get_quiz_data') }}?course_id=${courseId}&quiz_id=${quizId}`);
        const data = await response.json();
        
        if (data.success) {
            currentCourse = data.course;
            currentQuiz = data.quiz;
            renderQuiz(data.course, data.quiz, data.progress);
            showTab('quiz');
            // Show quiz tab button
            document.querySelector('button[onclick="showTab(\'quiz\')"]').style.display = 'block';
        } else {
            showFlashMessage(data.message || 'Error loading quiz', 'error');
        }
    } catch (error) {
        console.error('Error loading quiz:', error);
        showFlashMessage('Error loading quiz', 'error');
    } finally {
        hideLoading();
    }
}

// Render quiz
function renderQuiz(course, quiz, progress) {
    const content = document.getElementById('quiz-content');
    const quizScore = progress.quiz_scores ? progress.quiz_scores[quiz.id] : null;
    
    content.innerHTML = `
        <div class="quiz-container">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h1 class="text-3xl font-bold mb-3 text-gray-800">
                        <i class="fas fa-question-circle mr-3 text-blue-600"></i>Quiz
                    </h1>
                    <p class="text-gray-600 text-lg">${course.title_en}</p>
                    <div class="text-sm text-gray-500 mt-2">
                        ${quiz.questions.length} questions • Multiple choice
                    </div>
                </div>
                <button onclick="loadCourseOverview('${course.id}')" class="text-gray-500 hover:text-gray-700 text-2xl p-2 rounded-full hover:bg-gray-100 transition-all">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            ${quizScore !== null ? 
                `<div class="bg-green-100 border border-green-400 text-green-700 px-6 py-4 rounded-xl mb-8 flex items-center">
                    <i class="fas fa-check-circle mr-3 text-xl"></i>
                    <div>
                        <div class="font-semibold">Quiz Completed!</div>
                        <div>Score: ${quizScore}/${quiz.questions.length} (${Math.round((quizScore/quiz.questions.length)*100)}%)</div>
                    </div>
                </div>` : 
                `<div class="bg-blue-100 border border-blue-400 text-blue-700 px-6 py-4 rounded-xl mb-8 flex items-center">
                    <i class="fas fa-info-circle mr-3 text-xl"></i>
                    <div>
                        <div class="font-semibold">Ready to test your knowledge?</div>
                        <div>Answer all questions and submit to see your results.</div>
                    </div>
                </div>`
            }
            
            <form id="quiz-form" onsubmit="submitQuiz(event, '${course.id}', '${quiz.id}')">
                <div class="space-y-8">
                    ${quiz.questions.map((question, index) => `
                        <div class="bg-gray-50 rounded-xl p-6">
                            <h3 class="text-xl font-semibold mb-6 text-gray-800">
                                <span class="bg-blue-600 text-white rounded-full w-8 h-8 inline-flex items-center justify-center mr-3 text-sm">${index + 1}</span>
                                ${question.question_en}
                            </h3>
                            <div class="space-y-3">
                                ${question.options_en.map((option, optIndex) => `
                                    <label class="quiz-option block cursor-pointer ${quizScore !== null ? 'opacity-75 cursor-not-allowed' : ''}">
                                        <div class="flex items-center">
                                            <input type="radio" name="q${index}" value="${option}" 
                                                   class="mr-4 w-5 h-5 text-blue-600" ${quizScore !== null ? 'disabled' : ''}>
                                            <span class="text-gray-700 font-medium">${option}</span>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                ${quizScore === null ? 
                    `<div class="mt-8 text-center">
                        <button type="submit" class="btn-primary text-lg px-12 py-4">
                            <i class="fas fa-paper-plane mr-2"></i>Submit Quiz
                        </button>
                    </div>` : 
                    `<div class="mt-8 text-center">
                        <button onclick="loadCourseOverview('${course.id}')" class="btn-secondary text-lg px-12 py-4">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Course
                        </button>
                    </div>`
                }
            </form>
        </div>
    `;
    
    // Add click handlers for quiz options (only if quiz not completed)
    if (quizScore === null) {
        document.querySelectorAll('.quiz-option').forEach(option => {
            option.addEventListener('click', function() {
                const radio = this.querySelector('input[type="radio"]');
                if (!radio.disabled) {
                    radio.checked = true;
                    // Remove selected class from siblings
                    this.parentElement.querySelectorAll('.quiz-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    // Add selected class to this option
                    this.classList.add('selected');
                }
            });
        });
    }
}

// Submit quiz
async function submitQuiz(event, courseId, quizId) {
    event.preventDefault();
    showLoading();
    
    try {
        const formData = new FormData(event.target);
        formData.append('course_id', courseId);
        formData.append('quiz_id', quizId);
        formData.append('action', 'submit_quiz');
        formData.append('csrf_token', getCSRFToken());
        
        const response = await fetch('{{ url_for("learning_hub.quiz_action") }}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Reload quiz to show results
            loadQuiz(courseId, quizId);
            showFlashMessage(`Quiz completed! Score: ${data.score}/${data.total} (${Math.round((data.score/data.total)*100)}%)`, 'success');
        } else {
            showFlashMessage(data.message || 'Error submitting quiz', 'error');
        }
    } catch (error) {
        console.error('Error submitting quiz:', error);
        showFlashMessage('Error submitting quiz', 'error');
    } finally {
        hideLoading();
    }
}

// Get CSRF token
function getCSRFToken() {
    const meta = document.querySelector('meta[name=csrf-token]');
    return meta ? meta.getAttribute('content') : '';
}

// Show flash message
function showFlashMessage(message, type) {
    const container = document.querySelector('.container');
    const alertDiv = document.createElement('div');
    alertDiv.className = `bg-${type === 'success' ? 'green' : 'red'}-100 border border-${type === 'success' ? 'green' : 'red'}-400 text-${type === 'success' ? 'green' : 'red'}-700 px-6 py-4 rounded-lg mb-4 fade-in shadow-lg`;
    alertDiv.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} mr-3"></i>
                ${message}
            </div>
            <button onclick="this.parentElement.parentElement.style.display='none'" class="text-xl font-bold hover:opacity-70">&times;</button>
        </div>
    `;
    
    const firstChild = container.firstElementChild;
    container.insertBefore(alertDiv, firstChild);
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.style.opacity = '0';
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 300);
        }
    }, 5000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set initial tab based on URL hash or default to dashboard
    const hash = window.location.hash.substring(1);
    if (hash && document.getElementById(hash + '-tab')) {
        showTab(hash);
    } else {
        showTab('dashboard');
    }
    
    // Add CSRF token to meta tag if not present
    if (!document.querySelector('meta[name=csrf-token]')) {
        const meta = document.createElement('meta');
        meta.name = 'csrf-token';
        meta.content = '{{ csrf_token() }}';
        document.head.appendChild(meta);
    }
    
    // Handle browser back/forward
    window.addEventListener('popstate', function() {
        const hash = window.location.hash.substring(1);
        if (hash && document.getElementById(hash + '-tab')) {
            showTab(hash);
        } else {
            showTab('dashboard');
        }
    });
});
</script>
{% endblock %}